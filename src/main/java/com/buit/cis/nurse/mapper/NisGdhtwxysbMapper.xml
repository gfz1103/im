<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 住院患者管道滑脱危险因素评估表 -->
<mapper namespace="com.buit.cis.nurse.dao.NisGdhtwxysbDao">

    <!-- 用于select查询公用抽取的列 -->
    <sql id="columns">
        JLXH as jlxh,ZYH as zyh,MBLX as mblx,GWFXGD as gwfxgd,ZWFXGD as zwfxgd,DWFXGD as dwfxgd,QT as qt,HLCS as hlcs,HSQM as hsqm,RQ as rq,JGID as jgid,ZF as zf
    </sql>

    <insert id="insert">
        INSERT INTO NIS_GDHTWXYSB (
            JLXH ,
            ZYH ,
            MBLX ,
            GWFXGD ,
            ZWFXGD ,
            DWFXGD ,
            QT ,
            HLCS ,
            HSQM ,
            RQ ,
            JGID ,
            ZF 
        ) VALUES (
            #{jlxh} ,
            #{zyh} ,
            #{mblx} ,
            #{gwfxgd} ,
            #{zwfxgd} ,
            #{dwfxgd} ,
            #{qt} ,
            #{hlcs} ,
            #{hsqm} ,
            #{rq} ,
            #{jgid} ,
            #{zf} 
        )
    </insert>
    
    <update id="update" >
        UPDATE NIS_GDHTWXYSB SET
            ZYH = #{zyh} ,
            MBLX = #{mblx} ,
            GWFXGD = #{gwfxgd} ,
            ZWFXGD = #{zwfxgd} ,
            DWFXGD = #{dwfxgd} ,
            QT = #{qt} ,
            HLCS = #{hlcs} ,
            HSQM = #{hsqm} ,
            RQ = #{rq} ,
            JGID = #{jgid} ,
            ZF = #{zf} 
        WHERE 
            JLXH = #{jlxh}           
    </update>

    <delete id="deleteById">
        DELETE FROM NIS_GDHTWXYSB WHERE
        JLXH = #{jlxh} 
    </delete>
    
    <delete id="removeByEntity">
        DELETE FROM NIS_GDHTWXYSB <include refid="where"/>  
    </delete>
    
    <select id="getById" resultType="NisGdhtwxysb">
        SELECT <include refid="columns" />
            FROM NIS_GDHTWXYSB 
            WHERE 
        JLXH = #{jlxh} 
    </select>
    
    <sql id="where">
        <where>                          
<!--                <if test="@sqlt.Ognl@isNotEmpty(jlxh)"> -->
<!--                     AND JLXH = #{jlxh} -->
<!--                </if> -->
                <if test="@sqlt.Ognl@isNotEmpty(zyh)">
                     AND ZYH = #{zyh}
                </if>
<!--                <if test="@sqlt.Ognl@isNotEmpty(mblx)"> -->
<!--                     AND MBLX = #{mblx} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(gwfxgd)"> -->
<!--                     AND GWFXGD = #{gwfxgd} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(zwfxgd)"> -->
<!--                     AND ZWFXGD = #{zwfxgd} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(dwfxgd)"> -->
<!--                     AND DWFXGD = #{dwfxgd} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(qt)"> -->
<!--                     AND QT = #{qt} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(hlcs)"> -->
<!--                     AND HLCS = #{hlcs} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(hsqm)"> -->
<!--                     AND HSQM = #{hsqm} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(rq)"> -->
<!--                     AND RQ = #{rq} -->
<!--                </if> -->
               <if test="@sqlt.Ognl@isNotEmpty(jgid)">
                    AND JGID = #{jgid}
               </if>
<!--                <if test="@sqlt.Ognl@isNotEmpty(zf)"> -->
<!--                     AND ZF = #{zf} -->
<!--                </if> -->
        </where>
    </sql>
        
    <select id="findByEntityCount" resultType="long">
        SELECT count(*) FROM NIS_GDHTWXYSB 
        <include refid="where"/>    
    </select>
    
    <select id="findByEntity" resultType="NisGdhtwxysb">
        SELECT <include refid="columns" />
        FROM NIS_GDHTWXYSB 
        <include refid="where"/>
        
        <if test="@sqlt.Ognl@orderIsNotEmpty(sortColumns)">
            ORDER BY ${sortColumns}
        </if>
    </select>
    <!--     业务sql      -->
    
    <!-- 管道滑脱危险因素表查询树结构-->
    <select id="queryGdhtTree" resultType="com.buit.cis.nurse.response.NisHzmbResp">
        SELECT a.RQ as LABEL, a.MBLX as NAME
			FROM ( SELECT DATE_FORMAT( RQ, '%Y-%m' ) AS RQ, 
							ZYH as ZYH,
							MBLX as MBLX,
							JGID as JGID
				FROM NIS_GDHTWXYSB 
				GROUP BY 
					DATE_FORMAT(RQ, '%Y-%m'),
					ZYH,
					MBLX,
					JGID 
				) a, NIS_HZMB b WHERE
				a.ZYH = b.ZYH 
				AND a.MBLX = b.MBLX 
				AND a.JGID = b.JGID
				AND a.ZYH = #{zyh}
				AND a.JGID = #{jgid}
				order by a.RQ
    </select>
    
    <!-- 根据日期查询管道滑脱危险因素表 -->
    <select id="queryGdhtwByDate" resultType="com.buit.cis.nurse.response.NisGdhtwxysbResp">
       SELECT JLXH as jlxh,ZYH as zyh,MBLX as mblx,GWFXGD as gwfxgd,ZWFXGD as zwfxgd,DWFXGD as dwfxgd,QT as qt,HLCS as hlcs,HSQM as hsqm,date_format(RQ, '%Y-%m-%d %H:%i') as rq,JGID as jgid,ZF as zf
        FROM NIS_GDHTWXYSB 
        WHERE ZYH = #{zyh}
		<if test="@sqlt.Ognl@isNotEmpty(queryDate)">
			  and DATE_FORMAT(RQ, '%m-%d') = #{queryDate}
        </if> 
        <if test="@sqlt.Ognl@isNotEmpty(yearMonth)">
			  and DATE_FORMAT(RQ, '%Y-%m') = #{yearMonth}
        </if> 
        and JGID = #{jgid}
        order by RQ
    </select>
    
    <!-- 根据日期查询管道滑脱危险因素表打印信息 -->
    <select id="queryPrintGdhtwByDate" resultType="java.util.HashMap">
       select date_format(rq, '%Y-%m-%d %H:%i') as rq,
        case when find_in_set('胸管/心包引流管',gwfxgd) > 0 then '√' else '' end as gdlx1,
        case when find_in_set('气管插管/切开导管',gwfxgd) > 0 then '√' else '' end as gdlx2,
        case when find_in_set('动静脉插管',gwfxgd) > 0 then '√' else '' end as gdlx3,
        case when find_in_set('脑室引流管',gwfxgd) > 0 then '√' else '' end as gdlx4,
        case when find_in_set('深静脉导管/PICC',gwfxgd) > 0 then '√' else '' end as gdlx5,
        case when find_in_set('T管/PTCD',gwfxgd) > 0 then '√' else '' end as gdlx6,
        case when find_in_set('双套管/腹腔引流管',gwfxgd) > 0 then '√' else '' end as gdlx7,
        case when find_in_set('负压球/鼻胰管',gwfxgd) > 0 then '√' else '' end as gdlx8,
        case when find_in_set('三腔管/伤口引流管',gwfxgd) > 0 then '√' else '' end as gdlx9,
        case when find_in_set('造瘘管/鼻空肠管',gwfxgd) > 0 then '√' else '' end as gdlx10,
        case when find_in_set('导尿管/肛管',gwfxgd) > 0 then '√' else '' end as gdlx11,
        case when find_in_set('胃管/鼻胆管',gwfxgd) > 0 then '√' else '' end as gdlx12,
        case when find_in_set('吸氧管',gwfxgd) > 0 then '√' else '' end as gdlx13,
        case when find_in_set('外周静脉输液管',gwfxgd) > 0 then '√' else '' end as gdlx14,
        case when find_in_set('睡时多无意识活动',qt) > 0 then '√' else '' end as qt1,
        case when find_in_set('轻度烦躁',qt) > 0 then '√' else '' end as qt2,
        case when find_in_set('中度烦躁',qt) > 0 then '√' else '' end as qt3,
        case when find_in_set('重度烦躁',qt) > 0 then '√' else '' end as qt4,
        case when find_in_set('意识不清/不配合',qt) > 0 then '√' else '' end as qt5,
        case when find_in_set('幼儿',qt) > 0 then '√' else '' end as qt6,
        case when find_in_set('呃逆/呛咳',qt) > 0 then '√' else '' end as qt7,
        case when find_in_set('沟通障碍',qt) > 0 then '√' else '' end as qt8,
        case when find_in_set('肥胖颈部短',qt) > 0 then '√' else '' end as qt9,
        zf,
        hlcs,
        hsqm
        from nis_gdhtwxysb 
        where zyh = #{zyh}
		<if test="@sqlt.Ognl@isNotEmpty(queryDate)">
			  and date_format(rq, '%m-%d') = #{queryDate}
        </if> 
        <if test="@sqlt.Ognl@isNotEmpty(yearMonth)">
			  and date_format(rq, '%Y-%m') = #{yearMonth}
        </if> 
        and jgid = #{jgid}
        order by rq
    </select>
    
    <select id="queryGdhtTreeDetail" resultType="com.buit.cis.nurse.response.NisHzmbDetailResp">
         select concat(date_format(a.rq, '%m-%d'), '  ', b.mbmc ) as label, a.mblx as name
			from nis_gdhtwxysb a, nis_hzmb b 
			where a.zyh = b.zyh 
			and a.mblx = b.mblx 
			and a.jgid = b.jgid
			and a.zyh = #{zyh}
			and a.jgid = #{jgid}
			and date_format(a.rq, '%Y-%m') = #{yearMonth}
			group by concat(date_format(a.rq, '%m-%d'), ' ', b.mbmc ), a.mblx
			order by a.rq
    </select>
</mapper>

