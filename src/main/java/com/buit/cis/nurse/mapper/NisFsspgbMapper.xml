<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 深静脉血栓风险评估表 -->
<mapper namespace="com.buit.cis.nurse.dao.NisFsspgbDao">

    <!-- 用于select查询公用抽取的列 -->
    <sql id="columns">
        JLXH as jlxh,ZYH as zyh,MBLX as mblx,YBQK as ybqk,TSJB as tsjb,SSHZL as sshzl,HLCS as hlcs,HSQM as hsqm,RQ as rq,ZF as zf,JGID as jgid
    </sql>

    <insert id="insert">
        INSERT INTO NIS_FSSPGB (
            JLXH ,
            ZYH ,
            MBLX ,
            YBQK ,
            TSJB ,
            SSHZL ,
            HLCS ,
            HSQM ,
            RQ ,
            ZF ,
            JGID 
        ) VALUES (
            #{jlxh} ,
            #{zyh} ,
            #{mblx} ,
            #{ybqk} ,
            #{tsjb} ,
            #{sshzl} ,
            #{hlcs} ,
            #{hsqm} ,
            #{rq} ,
            #{zf} ,
            #{jgid} 
        )
    </insert>
    
    <update id="update" >
        UPDATE NIS_FSSPGB SET
            ZYH = #{zyh} ,
            MBLX = #{mblx} ,
            YBQK = #{ybqk} ,
            TSJB = #{tsjb} ,
            SSHZL = #{sshzl} ,
            HLCS = #{hlcs} ,
            HSQM = #{hsqm} ,
            RQ = #{rq} ,
            ZF = #{zf} ,
            JGID = #{jgid} 
        WHERE 
            JLXH = #{jlxh}           
    </update>

    <delete id="deleteById">
        DELETE FROM NIS_FSSPGB WHERE
        JLXH = #{jlxh} 
    </delete>
    
    <delete id="removeByEntity">
        DELETE FROM NIS_FSSPGB <include refid="where"/>  
    </delete>
    
    <select id="getById" resultType="NisFsspgb">
        SELECT <include refid="columns" />
            FROM NIS_FSSPGB 
            WHERE 
        JLXH = #{jlxh} 
    </select>
    
    <sql id="where">
        <where>                          
<!--                <if test="@sqlt.Ognl@isNotEmpty(jlxh)"> -->
<!--                     AND JLXH = #{jlxh} -->
<!--                </if> -->
                <if test="@sqlt.Ognl@isNotEmpty(zyh)">
                     AND ZYH = #{zyh}
                </if>
<!--                <if test="@sqlt.Ognl@isNotEmpty(mblx)"> -->
<!--                     AND MBLX = #{mblx} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(ybqk)"> -->
<!--                     AND YBQK = #{ybqk} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(tsjb)"> -->
<!--                     AND TSJB = #{tsjb} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(sshzl)"> -->
<!--                     AND SSHZL = #{sshzl} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(hlcs)"> -->
<!--                     AND HLCS = #{hlcs} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(hsqm)"> -->
<!--                     AND HSQM = #{hsqm} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(rq)"> -->
<!--                     AND RQ = #{rq} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(zf)"> -->
<!--                     AND ZF = #{zf} -->
<!--                </if> -->
               <if test="@sqlt.Ognl@isNotEmpty(jgid)">
                    AND JGID = #{jgid}
               </if>
        </where>
    </sql>
        
    <select id="findByEntityCount" resultType="long">
        SELECT count(*) FROM NIS_FSSPGB 
        <include refid="where"/>    
    </select>
    
    <select id="findByEntity" resultType="NisFsspgb">
        SELECT <include refid="columns" />
        FROM NIS_FSSPGB 
        <include refid="where"/>
        
        <if test="@sqlt.Ognl@orderIsNotEmpty(sortColumns)">
            ORDER BY ${sortColumns}
        </if>
    </select>
    <!--     业务sql      -->
    
    <!-- 深静脉血栓风险评估表查询树结构-->
    <select id="queryFsspgbTree" resultType="com.buit.cis.nurse.response.NisHzmbResp">
        SELECT a.RQ as LABEL, a.MBLX as NAME
			FROM ( SELECT DATE_FORMAT( RQ, '%Y-%m' ) AS RQ, 
							ZYH as ZYH,
							MBLX as MBLX,
							JGID as JGID
				FROM NIS_FSSPGB 
				WHERE MBLX = #{mblx}
				GROUP BY 
					DATE_FORMAT(RQ, '%Y-%m'),
					ZYH,
					MBLX,
					JGID 
				) a, NIS_HZMB b WHERE
				a.ZYH = b.ZYH 
				AND a.MBLX = b.MBLX 
				AND a.JGID = b.JGID
				AND a.ZYH = #{zyh}
				AND a.JGID = #{jgid}
				order by a.RQ
    </select>
    
    <!-- 根据日期查询深静脉血栓风险评估表 -->
    <select id="queryFsspgbByDate" resultType="com.buit.cis.nurse.response.NisFsspgbResp">
       SELECT JLXH as jlxh,ZYH as zyh,MBLX as mblx,YBQK as ybqk,TSJB as tsjb,SSHZL as sshzl,HLCS as hlcs,HSQM as hsqm,date_format(RQ, '%Y-%m-%d %H:%i') as rq,ZF as zf,JGID as jgid
        FROM NIS_FSSPGB 
        WHERE ZYH = #{zyh}
		<if test="@sqlt.Ognl@isNotEmpty(queryDate)">
			  and DATE_FORMAT(RQ, '%m-%d') = #{queryDate}
        </if> 
        <if test="@sqlt.Ognl@isNotEmpty(yearMonth)">
			  and DATE_FORMAT(RQ, '%Y-%m') = #{yearMonth}
        </if>  
        and MBLX = #{mblx}
        and JGID = #{jgid}
        order by RQ
    </select>
    
    <!-- 根据日期查询深静脉血栓风险评估表打印信息 -->
    <select id="queryPrintFsspgbByDate" resultType="java.util.HashMap">
       select date_format(rq, '%Y-%m-%d %H:%i') as rq,
        case when find_in_set('年龄≥60岁',ybqk) > 0 then '√' else '' end as ybqk1,
        case when find_in_set('吸烟史',ybqk) > 0 then '√' else '' end as ybqk2,
        case when find_in_set('卧床或肢体制动>72h',ybqk) > 0 then '√' else '' end as ybqk3,
        case when find_in_set('BMI≥25',ybqk) > 0 then '√' else '' end as ybqk4,
        case when find_in_set('妊娠或产褥期',ybqk) > 0 then '√' else '' end as ybqk5,
        case when find_in_set('有DVT或PE病史',ybqk) > 0 then '√' else '' end as ybqk6,
        case when find_in_set('大手术史',ybqk) > 0 then '√' else '' end as ybqk7,
        case when find_in_set('恶性肿瘤',tsjb) > 0 then '√' else '' end as tsjb1,
        case when find_in_set('骨折及创伤',tsjb) > 0 then '√' else '' end as tsjb2,
        case when find_in_set('下肢静脉曲张或静脉炎',tsjb) > 0 then '√' else '' end as tsjb3,
        case when find_in_set('血液高凝',tsjb) > 0 then '√' else '' end as tsjb4,
        case when find_in_set('心脏病',tsjb) > 0 then '√' else '' end as tsjb5,
        case when find_in_set('1月内脑卒中',tsjb) > 0 then '√' else '' end as tsjb6,
        case when find_in_set('瘫痪或脊髓损伤',tsjb) > 0 then '√' else '' end as tsjb7,
        case when find_in_set('糖尿病',tsjb) > 0 then '√' else '' end as tsjb8,
        case when find_in_set('溃疡性结肠炎',tsjb) > 0 then '√' else '' end as tsjb9,
        case when find_in_set('下肢/髋/盆腔大手术',sshzl) > 0 then '√' else '' end as sshzl1,
        case when find_in_set('手术时间>45分钟',sshzl) > 0 then '√' else '' end as sshzl2,
        case when find_in_set('手术伴严重心衰/心梗/感染静脉',sshzl) > 0 then '√' else '' end as sshzl3,
        case when find_in_set('下肢石膏固定',sshzl) > 0 then '√' else '' end as sshzl4,
        case when find_in_set('口服避孕药或激素治疗',sshzl) > 0 then '√' else '' end as sshzl5,
        case when find_in_set('深静脉置管',sshzl) > 0 then '√' else '' end as sshzl6,
        zf,
        hlcs,
        hsqm
        from nis_fsspgb 
        where zyh = #{zyh}
		<if test="@sqlt.Ognl@isNotEmpty(queryDate)">
			  and date_format(rq, '%m-%d') = #{queryDate}
        </if> 
        <if test="@sqlt.Ognl@isNotEmpty(yearMonth)">
			  and date_format(rq, '%Y-%m') = #{yearMonth}
        </if>  
        and mblx = #{mblx}
        and jgid = #{jgid}
        order by rq
    </select>
    
    <select id="queryFsspgbTreeDetail" resultType="com.buit.cis.nurse.response.NisHzmbDetailResp">
         select concat(date_format(a.rq, '%m-%d'), '  ', b.mbmc ) as label, a.mblx as name
			from nis_fsspgb a, nis_hzmb b 
			where a.zyh = b.zyh 
			and a.mblx = b.mblx 
			and a.jgid = b.jgid
			and a.zyh = #{zyh}
			and a.mblx = #{mblx}
			and a.jgid = #{jgid}
			and date_format(a.rq, '%Y-%m') = #{yearMonth}
			group by concat(date_format(a.rq, '%m-%d'), ' ', b.mbmc ), a.mblx
			order by a.rq
    </select>
</mapper>

