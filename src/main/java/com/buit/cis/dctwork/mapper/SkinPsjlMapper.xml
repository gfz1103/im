<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 公用_病人皮试记录 -->
<mapper namespace="com.buit.cis.dctwork.dao.SkinPsjlDao">

    <!-- 用于select查询公用抽取的列 -->
    <sql id="columns">
        JLXH as jlxh,BRID as brid,YPXH as ypxh,JGID as jgid,PSJG as psjg,PSLY as psly,GMZZ as gmzz,QTZZ as qtzz,BLFY as blfy,CZSJ as czsj,PSSJ as pssj,GMLB as gmlb
    </sql>

    <insert id="insert">
        INSERT INTO SKIN_PSJL (
            JLXH ,
            BRID ,
            YPXH ,
            JGID ,
            PSJG ,
            PSLY ,
            GMZZ ,
            QTZZ ,
            BLFY ,
            CZSJ ,
            PSSJ ,
            GMLB 
        ) VALUES (
            #{jlxh} ,
            #{brid} ,
            #{ypxh} ,
            #{jgid} ,
            #{psjg} ,
            #{psly} ,
            #{gmzz} ,
            #{qtzz} ,
            #{blfy} ,
            #{czsj} ,
            #{pssj} ,
            #{gmlb}
        )
    </insert>
    
    <update id="update" >
        UPDATE SKIN_PSJL SET
            BRID = #{brid} ,
            YPXH = #{ypxh} ,
            JGID = #{jgid} ,
            PSJG = #{psjg} ,
            PSLY = #{psly} ,
            GMZZ = #{gmzz} ,
            QTZZ = #{qtzz} ,
            BLFY = #{blfy} ,
            CZSJ = #{czsj} ,
            PSSJ = #{pssj} ,
            GMLB = #{gmlb}
        WHERE 
            JLXH = #{jlxh}             
    </update>

    <delete id="deleteById">
        DELETE FROM SKIN_PSJL WHERE
        JLXH = #{jlxh} 
    </delete>
    
    <delete id="removeByEntity">
        DELETE FROM SKIN_PSJL <include refid="where"/>  
    </delete>
    
    <select id="getById" resultType="SkinPsjl">
        SELECT <include refid="columns" />
            FROM SKIN_PSJL 
            WHERE 
        JLXH = #{jlxh} 
    </select>
    
    <sql id="where">
        <where>          
        	    <if test="@sqlt.Ognl@isNotEmpty(brid)"> 
                     AND BRID = #{brid} 
                </if>               
                <if test="@sqlt.Ognl@isNotEmpty(ypxh)"> 
                     AND YPXH = #{ypxh} 
                </if>     
                <if test="@sqlt.Ognl@isNotEmpty(psjg)"> 
					 AND PSJG = #{psjg}
				</if> 
<!--                <if test="@sqlt.Ognl@isNotEmpty(jlxh)"> -->
<!--                     AND JLXH = #{jlxh} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(jgid)"> -->
<!--                     AND JGID = #{jgid} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(psly)"> -->
<!--                     AND PSLY = #{psly} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(gmzz)"> -->
<!--                     AND GMZZ = #{gmzz} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(qtzz)"> -->
<!--                     AND QTZZ = #{qtzz} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(blfy)"> -->
<!--                     AND BLFY = #{blfy} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(czsj)"> -->
<!--                     AND CZSJ = #{czsj} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(pssj)"> -->
<!--                     AND PSSJ = #{pssj} -->
<!--                </if> -->
<!--                <if test="@sqlt.Ognl@isNotEmpty(gmlb)"> -->
<!--                     AND GMLB = #{gmlb} -->
<!--                </if> -->
        </where>
    </sql>
        
    <select id="findByEntityCount" resultType="long">
        SELECT count(*) FROM SKIN_PSJL 
        <include refid="where"/>    
    </select>
    
    <select id="findByEntity" resultType="SkinPsjl">
        SELECT <include refid="columns" />
        FROM SKIN_PSJL 
        <include refid="where"/>
        
        <if test="@sqlt.Ognl@orderIsNotEmpty(sortColumns)">
            ORDER BY ${sortColumns}
        </if>
    </select>
    <!--     业务sql      -->
    
    <!-- 根据brid,jgid查询病人过敏药物 -->
    <select id="getAllergicDrugsByEntity" resultType="com.buit.cis.dctwork.response.SkinPsjlResp">
        select a.jlxh as jlxh,
		       a.brid as brid,
		       a.ypxh as ypxh,
		       b.ypmc as ypmc,
		       a.blfy as blfy,
		       a.gmzz as gmzz,
		       a.qtzz as qtzz,
		       a.psjg as psjg,
		       a.psly as psly,
		       a.jgid as jgid,
		       b.yybs as yybs,
		       b.gmywlb as gmywlb
			  from SKIN_PSJL a, v_drugs_typk b
			 where a.ypxh = b.ypxh
			  <if test="@sqlt.Ognl@isNotEmpty(brid)"> 
	                and a.brid = #{brid} 
	          </if>
	          <if test="@sqlt.Ognl@isNotEmpty(jgid)"> 
	                and a.jgid = #{jgid} 
	          </if> 
    </select>
    
    <!-- 根据brid,ypxh,jgid删除过敏药物 -->
    <delete id="deleteByEntity">
        DELETE FROM SKIN_PSJL WHERE
        BRID = #{brid} and YPXH = #{ypxh}  and JGID = #{jgid} 
    </delete>
    
    <!-- -->
    <update id="updateAllergicDrugs" >
        UPDATE SKIN_PSJL SET
            GMZZ = #{gmzz} ,
            QTZZ = #{qtzz} ,
            BLFY = #{blfy} ,
            PSSJ = #{pssj} ,
            GMLB = #{gmlb} ,
            PSJG = #{psjg}
        WHERE 
            JLXH = #{jlxh}
    </update>

    <!-- 查询是否存在过敏药物类别最大时间 -->
    <select id="queryIsExtisMaxDate" resultType="SkinPsjl">
    	select * from skin_psjl where pssj  = (
            select max(pssj) from skin_psjl
            where brid = #{brid}
            and jgid = #{jgid}
            <if test="@sqlt.Ognl@isNotEmpty(ypxh)"> 
                and ypxh = #{ypxh}
            </if>
            <if test="@sqlt.Ognl@isNotEmpty(gmlb)"> 
                and gmlb = #{gmlb}
            </if>
        )
    </select>
    
    <!-- 过敏药物信息 -->
    <select id="queryAllergyDrugsInfo" resultType="com.buit.cis.dctwork.response.SkinPsjlDrugsResp">
        select a.jlxh as jlxh,
		       a.brid as brid,
		       a.ypxh as ypxh,
		       c.ypmc as ypmc,
		       a.blfy as blfy,
		       a.gmzz as gmzz,
		       a.qtzz as qtzz,
		       a.psjg as psjg,
		       a.psly as psly,
		       a.jgid as jgid,
		       a.czsj as czsj,
		       a.pssj as pssj,
		       a.gmlb as gmlb,
		       b.psyxq as psyxq
			  from skin_psjl a left join v_drugs_typk c on a.ypxh = c.ypxh
				left join skin_xm b on a.gmlb = b.gmywlx
			 where 1 = 1
			  <if test="@sqlt.Ognl@isNotEmpty(brid)"> 
	                and a.brid = #{brid} 
	          </if>
	          <if test="@sqlt.Ognl@isNotEmpty(jgid)"> 
	                and a.jgid = #{jgid} 
	          </if> 
    </select>
    
    <update id="updatePssj" >
        update skin_psjl set pssj = #{pssj} where pssj in (select a.pssj from (
            select max(pssj) as pssj from skin_psjl
            where brid = #{brid}
            and gmlb in
            <foreach collection="gmlbList" item="z" open="(" close=")" separator="," >
               	#{z}
     	    </foreach>	
        ) a ) and brid = #{brid}
        and gmlb in
        <foreach collection="gmlbList" item="z" open="(" close=")" separator="," >
            #{z}
   	    </foreach>	
    </update>
</mapper>

